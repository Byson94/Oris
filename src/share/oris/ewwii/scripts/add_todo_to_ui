#!/bin/bash

set -euo pipefail

TODO_FILE="$HOME/.local/share/ewwii/todo.txt"
mkdir -p "$(dirname "$TODO_FILE")"
touch "$TODO_FILE"

MODE=""
IS_APPEND="false"
todos=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        -s|--single)
            MODE="single"
            todos+=("$2")
            shift 2
            ;;
        -m|--map)
            MODE="map"
            shift
            while [[ $# -gt 0 && "$1" != -* ]]; do
                todos+=("$1")
                shift
            done
            ;;
        -a|--append)
            IS_APPEND="true"
            shift
            ;;
        *)
            echo "Unknown argument: $1" >&2
            exit 1
            ;;
    esac
done

if [[ ${#todos[@]} -eq 0 ]]; then
    echo "No todos provided. Use -s <todo> or -m <list>."
    exit 1
fi

widgets=()

for TODO in "${todos[@]}"; do
    [[ -z "$TODO" ]] && continue
    SAFE_TODO=$(printf '%s' "$TODO" | sed 's/"/\\"/g')
    WIDGET_ID=$(echo "$SAFE_TODO" | tr -cd '[:alnum:]_-')

    if [[ "$IS_APPEND" == "true" ]]; then
        if ! grep -Fxq "$SAFE_TODO" "$TODO_FILE"; then
            echo "$SAFE_TODO" >> "$TODO_FILE"
        fi
    fi

    widget=$(cat <<EOF
box(#{ 
    widget_name: "$WIDGET_ID", 
    dyn_id: "$WIDGET_ID",
    class: "todo-item",
    space_evenly: false,
    spacing: 10,
}, [
    scroll(#{ vscroll: false, hexpand: true }, [
        label(#{ 
            text: "$SAFE_TODO", 
            halign: "start" 
        }),
    ]),
    button(#{ 
        label: "Delete", 
        halign: "end",
        onclick: "bash -c 'ewwii wc remove \"$WIDGET_ID\" --config . && sed -i \"/^$SAFE_TODO\$/d\" \"$TODO_FILE\"'",
        timeout: "5s"
    })
])
EOF
)
    widgets+=("$widget")
done

ewwii wc create "${widgets[@]}" --parent "all_todos" --config .
